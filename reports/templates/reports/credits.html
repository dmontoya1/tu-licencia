{% extends 'webclient/base.html' %}

{% load static %}
{% load humanize %}

{% block extra_css %}
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.18/datatables.min.css"/>
{% endblock %}

{% block nav %}
{% endblock %}

{% block content %}
    <div class="col-10 form-box">
        <div class="container-fluid mb-5" >
            <div class="row justify-content-left">
                <div class="col-sm-12 col-lg-7" style="background-color: #fff;">
                    <h3 class="mt-5">Solicitudes de créditos de los Usuarios</h3>
                    <form class="purchases">
                        {% csrf_token %}
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="state" class="float-left">Departamento</label>
                                <select name="state" class="form-control" id="states" required>
                                    <option disabled selected value="">Seleccione un departamento</option>
                                    {% for state in states %}
                                        <option value="{{state.pk}}">{{state.name}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="cities" class="float-left">Ciudad</label>
                                <select name="city" class="form-control" id="cities" required>
                                    <option disabled selected value="">Seleccione primero un departamento</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="tramit" class="float-left">Selecciona el trámite</label>
                            <select class="form-control" id="tramit" name="tramit">
                                <option value="" selected disabled>Selecciona una licencia</option>
                                <option value="FL">Primera Licencia</option>
                                <option value="SL">Segunda Licencia</option>
                                <option value="RN">Renovación</option>
                                <option value="RC">Recategorización</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="credit_status" class="float-left">Selecciona el estado del crédito</label>
                            <select class="form-control" id="credit_status" name="credit_status">
                                <option value="" selected disabled>Selecciona una estado</option>
                                <option value="AC">Aceptado</option>
                                <option value="RE">Rechazado</option>
                                <option value="PA">Pendiente de aprobación</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="dates" class="float-left">Fecha inicio</label>
                                <input type="date" class="input-sm form-control start-date" name="start" required/>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="dates" class="float-left">Fecha de fin</label>
                                <input type="date" class="input-sm form-control end-date" name="end" required/>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary float-right mb-4">Generar Reporte</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="table" hidden>
            <table id="table_id" class="display">
                <thead class="thead">
                    <tr>
                        <th>Usuario</th>
                        <th>Documento</th>
                        <th>Número de reserva</th>
                        <th>CEA</th>
                        <th>CRC</th>
                        <th>Organismo de tránsito</th>
                        <th>Trámites</th>
                        <th>Fecha de Solicitud</th>
                        <th>Estado del crédito</th>
                    </tr>
                </thead>
                <tbody class="tbody">
                    <tr>
                        <td>Row 1 Data 1</td>
                        <td>Row 1 Data 2</td>
                        <td>Row 1 Data 2</td>
                        <td>Row 1 Data 2</td>
                        <td>Row 1 Data 2</td>
                        <td>Row 1 Data 2</td>
                        <td>Row 1 Data 2</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    


{% endblock %}


{% block extra_js %}
    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.18/datatables.min.js"></script>
    <script>

        $('#states').on('change', function(){
            axios.get(`/api/manager/city/${$(this).val()}`)
            .then(function (response) {
                data = response.data
                $('#cities').empty()
                $.each( data, function( k, v ) {
                    $('#cities').append(
                        `<option value=${v.id}>${v.name}</option>`
                    )
                });
                $('#cities').prepend(
                    `<option selected disabled>Selecciona una ciudad</option>`
                )
            })
            .catch(function (error) {
                console.log(error);
            })
        })

        $('.purchases').on('submit', function(ev) {
            ev.preventDefault()
            var table = $('#table_id')
            if ($('.table').hasClass('full')){
                console.log("Has classsss")
                table.DataTable().destroy()
                $('.table').removeClass('full')
            }
            params = {
                'city': $('#cities').val(),
                'start': $('.start-date').val(),
                'end': $('.end-date').val(),
                'tramit': $('#tramit').val(),
                'credit_status': $('#credit_status').val()
            }
            axios.defaults.headers.common['X-CSRFToken'] = '{{csrf_token}}';
            axios.post('/reports/credits/', params)
            .then(function(response){
                console.log(response)
                data = response.data
                $('.tbody').empty()
                $.each(data, function( k, v ) {
                    var str = ''
                    if (v.related_tramits.length > 1){
                        str = `<li>${v.related_tramits[1]}</li>`
                    }
                   
                    $('.tbody').append(
                        `
                        <tr>
                            <td>${v.user.first_name} ${v.user.last_name}</td>
                            <td>${v.user.document_id}</td>
                            <td>${v.booking}</td>
                            <td>${v.cea.name}</td>
                            <td>${v.crc.name}</td>
                            <td>${v.transit.name}</td>
                            <td>
                                <ul>
                                    <li>${v.related_tramits[0]}</li>
                                    ${str}
                                </ul>
                            </td>
                            <td>${v.request_date}</td>
                            <td>${v.credit_status}</td>
                        </tr>
                        `
                    )
                });
                
               table.DataTable({
                    language: {
                        "sProcessing":     "Procesando...",
                        "sLengthMenu":     "Mostrar _MENU_ registros",
                        "sZeroRecords":    "No se encontraron resultados",
                        "sEmptyTable":     "Ningún dato disponible en esta tabla",
                        "sInfo":           "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                        "sInfoEmpty":      "Mostrando registros del 0 al 0 de un total de 0 registros",
                        "sInfoFiltered":   "(filtrado de un total de _MAX_ registros)",
                        "sInfoPostFix":    "",
                        "sSearch":         "Buscar:",
                        "sUrl":            "",
                        "sInfoThousands":  ",",
                        "sLoadingRecords": "Cargando...",
                        "oPaginate": {
                            "sFirst":    "Primero",
                            "sLast":     "Último",
                            "sNext":     "Siguiente",
                            "sPrevious": "Anterior"
                        },
                        "oAria": {
                            "sSortAscending":  ": Activar para ordenar la columna de manera ascendente",
                            "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                        }
                    }
                });
                $('.table').addClass('full')
                $('.table').removeAttr('hidden')

            })
            .catch(function (error) {
                console.log(error);
            })
        })
    </script>
{% endblock %}